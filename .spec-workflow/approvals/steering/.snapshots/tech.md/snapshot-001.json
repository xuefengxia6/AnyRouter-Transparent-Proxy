{
  "id": "snapshot_1765293662904_vmdzb7lsu",
  "approvalId": "approval_1765293662901_bjextherz",
  "approvalTitle": "Tech 文档审批",
  "version": 1,
  "timestamp": "2025-12-09T15:21:02.904Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Technology Stack\n\n## Project Type\n**高性能异步 HTTP 代理服务** - 基于 FastAPI 的轻量级透明代理服务器，专为解决 Anthropic API 兼容性问题而设计，支持流式响应和企业级部署。\n\n## Core Technologies\n\n### Primary Language(s)\n- **Language**: Python 3.12 (现代化异步编程支持)\n- **Runtime**: CPython 官方解释器\n- **Language-specific tools**:\n  - pip (包管理器)\n  - venv (虚拟环境)\n  - Python async/await (异步编程范式)\n\n### Key Dependencies/Libraries\n- **FastAPI 0.115.5**: 现代高性能 Web 框架，支持自动 API 文档生成和异步处理\n- **Uvicorn 0.32.1**: ASGI 服务器，支持 HTTP/1.1 和 WebSocket，生产级性能\n- **httpx 0.28.1**: 现代异步 HTTP 客户端，支持 HTTP/2 和连接池复用\n- **python-dotenv 1.0.1**: 环境变量管理，支持 .env 文件配置\n\n### Application Architecture\n**事件驱动的异步代理架构**\n- **单线程异步模型**: 基于 asyncio 的事件循环，避免线程切换开销\n- **流式处理管道**: 请求→过滤→处理→转发→响应的流水线处理\n- **资源共享**: 全局 httpx.AsyncClient 实例实现连接池复用\n- **生命周期管理**: FastAPI lifespan 事件确保资源正确初始化和清理\n\n### Data Storage\n- **Primary storage**: 无状态设计，不持久化数据\n- **Configuration**: 环境变量 + JSON 配置文件\n- **Caching**: 连接池复用（httpx 内置）\n- **Data formats**: JSON (API 请求/响应), 环境配置文件\n\n### External Integrations\n- **APIs**: AnyRouter API (https://anyrouter.top) - Anthropic API 代理服务\n- **Protocols**:\n  - HTTP/1.1 (主要协议)\n  - HTTPS (加密传输)\n  - Server-Sent Events (流式响应)\n  - WebSocket (未来支持)\n- **Authentication**:\n  - API Key 转发\n  - 自定义请求头注入\n  - 透明身份验证\n\n### Monitoring & Dashboard Technologies\n- **Health Monitoring**: `/health` 端点用于容器健康检查\n- **Logging**: 结构化日志系统，支持调试模式\n- **Metrics**:\n  - 请求计数和状态码分布\n  - 响应时间统计\n  - 错误率监控\n- **Dashboard**: CLI 基础监控（未来 Web 界面）\n\n## Development Environment\n\n### Build & Development Tools\n- **Build System**: 无需编译，Python 解释执行\n- **Package Management**: pip + requirements.txt\n- **Development workflow**:\n  - 直接运行 `python app.py` (开发模式)\n  - Uvicorn 自动重载支持\n  - 异步调试友好\n\n### Code Quality Tools\n- **Static Analysis**:\n  - pyflakes (语法检查)\n  - mypy (类型检查，可选)\n- **Formatting**:\n  - black (代码格式化)\n  - isort (导入排序)\n- **Testing Framework**:\n  - pytest (单元测试)\n  - httpx TestClient (集成测试)\n- **Documentation**:\n  - 中文注释\n  - Markdown 文档\n  - FastAPI 自动生成 API 文档\n\n### Version Control & Collaboration\n- **VCS**: Git\n- **Branching Strategy**:\n  - main (主分支)\n  - feature/* (功能分支)\n  - hotfix/* (热修复分支)\n- **Code Review Process**:\n  - Pull Request 审查\n  - 自动化测试验证\n  - 代码质量检查\n\n### Dashboard Development\n- **Live Reload**: Uvicorn 自动重载\n- **Port Management**: 可配置端口 (默认 8088)\n- **Multi-Instance Support**: 支持多实例部署（通过端口配置）\n\n## Deployment & Distribution\n- **Target Platform(s)**:\n  - Linux (生产环境主要目标)\n  - macOS (开发环境)\n  - Windows (支持)\n  - Docker 容器化部署\n- **Distribution Method**:\n  - Docker Hub / 私有镜像仓库\n  - GitHub 源码分发\n  - pip 包 (未来计划)\n- **Installation Requirements**:\n  - Python 3.12+\n  - 网络连接访问上游 API\n  - 最小内存: 128MB\n  - 推荐内存: 512MB+\n- **Update Mechanism**:\n  - Docker 容器重新部署\n  - Git pull + 依赖更新\n  - 环境变量热更新\n\n## Technical Requirements & Constraints\n\n### Performance Requirements\n- **响应延迟**: 代理延迟 < 50ms (P99)\n- **吞吐量**: 支持 1000+ 并发连接\n- **内存使用**: 基础运行 < 128MB，每连接 < 1MB\n- **启动时间**: < 5 秒冷启动\n- **流式响应**: 支持 60+ 秒的长连接流式传输\n\n### Compatibility Requirements\n- **Platform Support**:\n  - Linux: Ubuntu 20.04+, CentOS 8+, Alpine 3.15+\n  - macOS: 11.0+ (Big Sur)\n  - Windows: 10+ (通过 WSL2 推荐)\n- **Dependency Versions**:\n  - Python: 3.12+ (利用最新异步特性)\n  - FastAPI: 0.100+ (确保 ASGI 支持)\n  - httpx: 0.25+ (HTTP/2 支持)\n- **Standards Compliance**:\n  - RFC 7230 (HTTP/1.1 消息语法和路由)\n  - RFC 7231 (HTTP 语义和内容)\n  - SSE 规范 (流式响应)\n\n### Security & Compliance\n- **Security Requirements**:\n  - 防重定向攻击 (follow_redirects=False)\n  - 请求超时保护 (60秒)\n  - 敏感信息过滤 (生产环境日志)\n  - HTTP 头部安全过滤\n- **Compliance Standards**:\n  - 数据保护合规 (不记录敏感请求内容)\n  - 企业安全标准 (可配置的安全策略)\n- **Threat Model**:\n  - DoS 攻击防护 (超时和连接限制)\n  - 中间人攻击防护 (HTTPS 传输)\n  - 资源耗尽防护 (连接池管理)\n\n### Scalability & Reliability\n- **Expected Load**:\n  - 并发连接: 1000+\n  - 请求速率: 10,000+ req/min\n  - 数据传输: 1GB+ per minute\n- **Availability Requirements**:\n  - 正常运行时间: 99.9%\n  - 故障恢复: < 30 秒\n  - 优雅关闭: 确保连接正确关闭\n- **Growth Projections**:\n  - 水平扩展: 支持多实例负载均衡\n  - 垂直扩展: 支持 8GB+ 内存使用\n  - 地理分布: 支持多地域部署\n\n## Technical Decisions & Rationale\n\n### Decision Log\n1. **FastAPI + Uvicorn 架构选择**:\n   - **理由**: FastAPI 提供现代异步编程模型，自动 API 文档，类型提示支持；Uvicorn 是生产级 ASGI 服务器，性能优异\n   - **替代方案**: Flask + Gunicorn (传统同步模型), Django Nginx (过重), Node.js Express (生态差异)\n\n2. **httpx 异步客户端**:\n   - **理由**: 原生支持 async/await，HTTP/2 支持，连接池复用，API 设计现代\n   - **替代方案**: aiohttp (API 复杂), requests (同步), urllib3 (功能有限)\n\n3. **单文件架构设计**:\n   - **理由**: 简化部署，降低复杂度，易于维护；功能内聚避免过度工程化\n   - **替代方案**: 微服务架构 (过度复杂), 模块化拆分 (当前规模不必要)\n\n4. **环境变量配置**:\n   - **理由**: 容器友好，12-Factor App 原则，运行时配置灵活性\n   - **替代方案**: 配置文件 (部署复杂), 命令行参数 (管理困难)\n\n5. **Docker 容器化部署**:\n   - **理由**: 环境一致性，易于扩展，标准化部署流程\n   - **替代方案**: 直接部署 (环境依赖问题), 系统包 (版本冲突)\n\n## Known Limitations\n\n### 当前技术限制\n- **单进程模型**:\n  - **影响**: CPU 利用率受限，无法充分利用多核\n  - **未来解决方案**: 多进程部署 + 负载均衡\n\n- **内存状态**:\n  - **影响**: 连接池和内存缓存无法跨实例共享\n  - **未来解决方案**: Redis 外部缓存，连接池分离\n\n### 功能限制\n- **协议支持**:\n  - **影响**: 暂不支持 WebSocket 和 HTTP/2 代理\n  - **计划时间**: 6 个月内实现 WebSocket 支持\n\n- **监控能力**:\n  - **影响**: 缺乏详细的性能指标和分析\n  - **计划时间**: 3 个月内添加 Prometheus metrics\n\n### 扩展性限制\n- **配置管理**:\n  - **影响**: 缺乏动态配置更新能力\n  - **解决方案**: 实现配置热重载机制\n\n- **安全功能**:\n  - **影响**: 缺乏访问控制和审计功能\n  - **解决方案**: 添加 API Key 验证和访问日志\n\n### 部署限制\n- **平台依赖**:\n  - **影响**: 依赖 Python 环境，部署复杂度较高\n  - **解决方案**: 提供静态编译版本或多阶段构建 Docker 镜像\n\n- **网络配置**:\n  - **影响**: 在复杂网络环境中的配置可能较为复杂\n  - **解决方案**: 提供网络诊断工具和配置向导",
  "fileStats": {
    "size": 7869,
    "lines": 227,
    "lastModified": "2025-12-09T15:20:23.975Z"
  },
  "comments": []
}