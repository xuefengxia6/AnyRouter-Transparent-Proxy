{
  "id": "snapshot_1765294221542_ofvylnott",
  "approvalId": "approval_1765294221540_kgk8y0lnf",
  "approvalTitle": "Structure 文档审批",
  "version": 1,
  "timestamp": "2025-12-09T15:30:21.542Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\nAnyRouter-Transparent-Proxy/\n├── app.py                          # 核心代理逻辑 (403行)\n├── requirements.txt                # Python 依赖清单\n├── .env.example                    # 环境变量配置模板\n├── .env                            # 本地环境变量 (不提交到版本控制)\n├── Dockerfile                      # Docker 镜像构建配置\n├── docker-compose.yml              # Docker Compose 编排配置\n├── README.md                       # 中文项目文档\n├── README_en.md                    # 英文项目文档\n├── CLAUDE.md                       # AI 上下文索引\n├── .claudeignore                   # Claude Code 忽略文件配置\n├── .spec-workflow/                 # 规范工作流目录\n│   ├── templates/                  # 规范模板目录\n│   │   ├── product-template.md     # 产品规范模板\n│   │   ├── tech-template.md        # 技术规范模板\n│   │   └── structure-template.md   # 结构规范模板\n│   └── steering/                   # 指导文档目录\n│       ├── product.md              # 产品指导文档\n│       ├── tech.md                 # 技术指导文档\n│       └── structure.md            # 项目结构文档 (本文件)\n└── env/                            # 环境配置目录\n    ├── .env.headers.json           # 自定义请求头配置\n    └── .env.headers.example        # 自定义请求头模板\n```\n\n### 结构设计原则\n- **单文件核心架构**: 所有业务逻辑集中在 `app.py`，降低部署复杂度\n- **配置外部化**: 环境变量和 JSON 配置文件，支持不同部署环境\n- **文档驱动**: 完整的中英文文档和 AI 上下文索引\n- **容器优先**: Docker 和 Docker Compose 作为主要部署方式\n- **规范化**: 使用 `.spec-workflow` 进行项目规范管理\n\n## Naming Conventions\n\n### Files\n- **Python 文件**: `snake_case` (例: `app.py`)\n- **配置文件**: 点开头+描述性名称 (例: `.env.example`)\n- **文档文件**: `kebab-case` (例: `README.md`, `README_en.md`)\n- **Docker 文件**: 标准命名 (例: `Dockerfile`, `docker-compose.yml`)\n- **环境文件**: `UPPER_SNAKE_CASE` (例: `.env.headers.json`)\n\n### Code\n- **类**: `PascalCase` (例: `AsyncHttpClient`)\n- **函数/方法**: `snake_case` (例: `filter_request_headers`)\n- **常量**: `UPPER_SNAKE_CASE` (例: `API_BASE_URL`, `SYSTEM_PROMPT_REPLACEMENT`)\n- **变量**: `snake_case` (例: `http_client`, `forward_headers`)\n- **环境变量**: `UPPER_SNAKE_CASE` (例: `DEBUG_MODE`, `PORT`)\n\n## Import Patterns\n\n### Import Order (Python 标准顺序)\n1. 标准库导入 (`os`, `json`, `asyncio`, 等)\n2. 第三方库导入 (`fastapi`, `httpx`, `uvicorn`, 等)\n3. 本地模块导入 (本项目内部，当前单文件架构下较少)\n4. 类型提示导入 (`from typing import ...`)\n\n### 导入示例\n```python\n# 标准库\nimport os\nimport json\nimport asyncio\nfrom typing import Dict, List, Optional\n\n# 第三方库\nfrom fastapi import FastAPI, Request, Response\nfrom fastapi.responses import StreamingResponse\nfrom httpx import AsyncClient\nimport uvicorn\n\n# 项目常量\nAPI_BASE_URL = os.getenv(\"API_BASE_URL\", \"https://anyrouter.top\")\n```\n\n## Code Structure Patterns\n\n### app.py 文件组织结构\n```python\n# 1. 导入和依赖\n#    - 标准库导入\n#    - 第三方库导入\n#    - 类型提示导入\n#    - 环境变量和常量定义\n\n# 2. 全局变量和配置\n#    - 环境变量加载\n#    - 全局 AsyncClient 实例\n#    - 配置验证\n\n# 3. 核心函数定义\n#    - lifespan() - 应用生命周期管理\n#    - load_custom_headers() - 配置加载\n#    - filter_request_headers() - 请求处理\n#    - filter_response_headers() - 响应处理\n#    - process_request_body() - 业务逻辑\n\n# 4. API 端点定义\n#    - health_check() - 健康检查\n#    - proxy() - 主代理函数\n\n# 5. FastAPI 应用初始化\n#    - app = FastAPI(lifespan=lifespan)\n#    - 路由注册\n\n# 6. 主程序入口\n#    - if __name__ == \"__main__\": 启动逻辑\n```\n\n### 函数组织模式\n```python\ndef function_name(param1: Type1, param2: Type2) -> ReturnType:\n    \"\"\"\n    函数文档字符串 (中文)\n\n    Args:\n        param1: 参数描述\n        param2: 参数描述\n\n    Returns:\n        返回值描述\n\n    Raises:\n        Exception: 异常情况描述\n    \"\"\"\n    # 1. 输入验证\n    if not param1:\n        raise ValueError(\"参数错误\")\n\n    try:\n        # 2. 核心逻辑\n        result = process_logic(param1, param2)\n\n        # 3. 结果处理\n        return format_result(result)\n\n    except Exception as e:\n        # 4. 错误处理\n        logger.error(f\"操作失败: {e}\")\n        raise\n```\n\n## Code Organization Principles\n\n### 1. **简洁至上 (Simplicity First)**\n- 单文件架构，避免过度工程化\n- 每个函数职责单一明确\n- 代码行数控制：单个函数不超过 50 行\n\n### 2. **可读性优先 (Readability Priority)**\n- 中文注释，便于团队理解\n- 一致的命名规范\n- 逻辑分层清晰\n\n### 3. **异步优先 (Async-First)**\n- 所有 I/O 操作使用 async/await\n- 流式响应处理\n- 非阻塞错误处理\n\n### 4. **配置驱动 (Configuration-Driven)**\n- 环境变量控制行为\n- JSON 配置文件支持复杂配置\n- 默认值合理\n\n## Module Boundaries\n\n### 核心模块边界\n```\n┌─────────────────────────────────────────────────────────────┐\n│                        app.py                              │\n│  ┌─────────────────┬─────────────────┬──────────────────┐  │\n│  │   配置管理      │    核心业务      │    API 端点      │  │\n│  │   Configuration │   Business      │   Endpoints      │  │\n│  │                 │   Logic         │                  │  │\n│  │ • 环境变量       │ • 请求头过滤     │ • 健康检查       │  │\n│  │ • JSON 配置     │ • System Prompt │ • 代理端点       │  │\n│  │ • 常量定义      │ • 响应处理       │ • 错误处理       │  │\n│  └─────────────────┴─────────────────┴──────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### 接口边界\n- **公共 API**: FastAPI 路由端点 (`/health`, `{proxy_path}`)\n- **内部函数**: 以下划线开头或无导出的辅助函数\n- **配置接口**: 环境变量和 JSON 文件\n\n### 依赖方向\n- **核心逻辑** → **配置系统** (读取配置)\n- **API 端点** → **核心逻辑** (调用业务函数)\n- **所有模块** → **HTTP 客户端** (网络通信)\n\n## Code Size Guidelines\n\n### 文件大小限制\n- **主文件 (app.py)**: 建议 < 500 行 (当前 403 行)\n- **配置文件**: < 100 行\n- **文档文件**: 不限制，但建议结构清晰\n\n### 函数大小限制\n- **简单函数**: < 20 行 (如 `filter_request_headers`)\n- **复杂函数**: < 50 行 (如 `proxy`, `process_request_body`)\n- **工具函数**: < 15 行 (如 `load_custom_headers`)\n\n### 复杂度限制\n- **嵌套深度**: 最大 4 层\n- **圈复杂度**: 单个函数 < 10\n- **参数个数**: 最多 5 个位置参数，超出使用关键字参数\n\n### 示例：函数大小控制\n```python\n# ✅ 好的例子 - 简洁明确\ndef filter_request_headers(headers: Dict[str, str]) -> Dict[str, str]:\n    \"\"\"过滤 HTTP 请求头，移除 hop-by-hop 头部\"\"\"\n    hop_by_hop_headers = {\n        \"connection\", \"keep-alive\", \"proxy-authenticate\",\n        \"proxy-authorization\", \"te\", \"trailers\", \"transfer-encoding\", \"upgrade\"\n    }\n\n    return {\n        k: v for k, v in headers.items()\n        if k.lower() not in hop_by_hop_headers\n    }\n```\n\n## Configuration Structure\n\n### 环境变量结构\n```bash\n# 核心配置\nAPI_BASE_URL=https://anyrouter.top\nPORT=8088\nDEBUG_MODE=false\n\n# 功能开关\nSYSTEM_PROMPT_REPLACEMENT=\nSYSTEM_PROMPT_BLOCK_INSERT_IF_NOT_EXIST=false\n\n# 网络配置\nHTTP_PROXY=\nHTTPS_PROXY=\n```\n\n### JSON 配置结构\n```json\n// env/.env.headers.json\n{\n  \"User-Agent\": \"claude-cli/2.0.8 (external, cli)\",\n  \"__comment\": \"以 __ 开头的字段会被忽略\",\n  \"__description\": \"自定义请求头配置文件\"\n}\n```\n\n## Documentation Standards\n\n### 代码注释规范\n- **文件头部注释**: 描述文件用途和主要功能\n- **函数文档字符串**: 使用 Google 风格，中文描述\n- **复杂逻辑注释**: 解释算法和业务逻辑\n- **TODO/FIXME**: 标记待完成和待修复项\n\n### 文档文件标准\n- **README.md**: 完整的项目说明，包含安装、配置、使用指南\n- **CLAUDE.md**: AI 上下文索引，包含架构图和技术细节\n- **代码注释**: 与代码语言保持一致 (中文)\n\n### API 文档\n- **FastAPI 自动生成**: `/docs` 端点提供 Swagger UI\n- **中文注释**: 确保自动文档的中文显示\n- **类型提示**: 完整的类型注解支持文档生成\n\n## Testing Structure (未来扩展)\n\n### 测试文件组织 (规划)\n```\ntests/\n├── test_app.py              # 主应用测试\n├── test_filters.py          # 请求/响应过滤测试\n├── test_config.py           # 配置加载测试\n├── conftest.py              # pytest 配置\n└── fixtures/                # 测试数据\n    └── sample_requests.json\n```\n\n### 测试命名规范\n- **测试文件**: `test_*.py`\n- **测试类**: `TestClassName`\n- **测试方法**: `test_function_name_scenario`\n\n## Deployment Structure\n\n### Docker 层次结构\n```\nDockerfile 构建层次:\n1. 基础层: python:3.12-slim\n2. 依赖层: requirements.txt\n3. 应用层: app.py + 配置\n4. 运行时层: 健康检查 + 启动命令\n```\n\n### 运行时环境\n- **开发环境**: 直接 Python 运行\n- **测试环境**: Docker Compose\n- **生产环境**: Docker + 外部负载均衡",
  "fileStats": {
    "size": 10308,
    "lines": 307,
    "lastModified": "2025-12-09T15:29:48.534Z"
  },
  "comments": []
}