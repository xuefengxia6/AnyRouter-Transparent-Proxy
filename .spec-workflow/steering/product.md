# Product Overview

## Product Purpose

**AnyRouter Transparent Proxy** 是一个专业级透明 HTTP 代理服务，旨在解决 AnyRouter Anthropic API 在 Claude Code for VS Code 插件中报错 500 的兼容性问题。通过提供完全透明的请求转发、智能 System Prompt 处理和实时监控能力，使开发者能够无缝集成 Claude AI 服务到各种开发工具和应用场景中。

本产品的核心价值在于：
- **零配置透明性**：完全兼容标准 HTTP 协议，无需修改客户端代码
- **智能请求处理**：自动处理 System Prompt 替换/插入，支持自定义请求头注入
- **企业级可靠性**：基于异步架构，支持高并发和长时间流式响应
- **可观测性**：提供 Web 管理面板，实时监控请求状态和性能指标

## Target Users

### 主要用户群体

1. **AI 应用开发者**
   - **需求**：需要在开发工具（如 VS Code、IDE 插件）中集成 Claude AI 服务
   - **痛点**：直接调用 AnyRouter API 遇到 500 错误，缺乏请求可见性和调试能力
   - **价值**：提供稳定的代理层，解决兼容性问题，提供请求日志和监控

2. **企业技术团队**
   - **需求**：需要统一管理和监控团队的 AI API 调用
   - **痛点**：缺乏集中式的请求管理、日志查询和成本监控能力
   - **价值**：提供统一的代理层和管理面板，支持请求统计、日志持久化和配额管理（未来）

3. **DevOps 工程师**
   - **需求**：需要在生产环境部署可靠的 API 代理服务
   - **痛点**：需要简单的部署方案和健康检查机制
   - **价值**：提供 Docker 容器化部署，支持健康检查和自动重启

4. **API 集成商**
   - **需求**：需要在多种场景下调用 Anthropic API（如批处理、定时任务、自动化脚本）
   - **痛点**：需要统一的请求处理逻辑（如 System Prompt 注入、自定义头部）
   - **价值**：提供可配置的请求增强能力，支持批量请求和流式响应

## Key Features

### 核心功能

1. **完全透明的 HTTP 代理**
   - 支持所有 HTTP 方法（GET/POST/PUT/DELETE/PATCH）
   - 自动过滤 hop-by-hop 头部，符合 RFC 7230 规范
   - 智能处理 Content-Length 和 Content-Encoding
   - 防重定向攻击和请求超时保护

2. **流式响应支持**
   - 基于 `httpx.AsyncClient` 和 `StreamingResponse` 的异步架构
   - 支持 Server-Sent Events (SSE) 流式传输
   - 零拷贝流式转发，低延迟高吞吐
   - 优雅的连接生命周期管理（BackgroundTask）

3. **智能 System Prompt 处理**
   - 支持两种模式：替换模式和插入模式
   - 仅在 `/v1/messages` 路由生效，其他路由完全透明
   - 插入模式：根据关键字判断是否插入或替换
   - 支持 `cache_control` 优化（ephemeral 缓存）

4. **自定义请求头注入**
   - 通过 `env/.env.headers.json` 配置自定义请求头
   - 支持注释字段（`__` 前缀）
   - 自动覆盖原请求中的同名头部
   - 动态加载，无需重启服务

5. **Web 管理面板**（✨ 已实现，PWA 支持）
   - **Dashboard**：总览统计数据、请求量趋势、成功率分析
   - **Monitoring**：实时请求监控、请求详情查看
   - **Logs**：日志查询、过滤和实时流（SSE）
   - **Config**：配置查看和修改建议
   - 支持离线访问和桌面安装（PWA）

6. **日志持久化与查询**（✨ 已实现）
   - 按日期分文件存储（`data/logs/YYYY-MM-DD.json`）
   - 支持日期范围查询和关键字搜索
   - 可配置保留天数和每日最大条数
   - 自动清理过期日志

7. **统计数据收集**（✨ 已实现）
   - 实时统计请求总数、成功/失败数、平均延迟
   - 按时间段统计（按小时、按天）
   - 支持导出和可视化（Chart.js）

## Business Objectives

### 业务目标

1. **解决核心痛点**
   - 彻底解决 Claude Code for VS Code 插件调用 AnyRouter API 的 500 错误问题
   - 提供稳定可靠的 API 代理服务，确保 99.9% 的可用性

2. **提升开发者体验**
   - 提供零配置的透明代理，开发者无需修改客户端代码
   - 提供 Web 管理面板，让开发者能够实时监控和调试 API 请求
   - 提供详细的日志和统计数据，帮助开发者快速定位问题

3. **降低运维成本**
   - 提供 Docker 容器化部署，简化部署和维护流程
   - 提供健康检查和自动重启机制，减少人工干预
   - 提供自动化日志清理机制，防止磁盘空间耗尽

4. **支持规模化应用**
   - 基于异步架构，支持高并发和长时间流式响应
   - 支持连接池复用，优化资源利用率
   - 为未来的多租户和 API Key 管理功能奠定基础

5. **建立开放生态**
   - 提供清晰的架构文档和代码注释，便于二次开发
   - 支持插件系统（未来），允许社区贡献扩展功能
   - 遵循 MIT 许可证，鼓励开源社区参与

## Success Metrics

### 成功指标

- **可用性**：99.9% 的服务正常运行时间（每月停机时间 < 43 分钟）
- **性能**：平均请求延迟 < 200ms（代理层开销）
- **稳定性**：零 5xx 错误（代理层自身错误），上游错误正确透传
- **并发能力**：单实例支持 100+ 并发流式请求
- **用户采用**：GitHub Stars > 100（6 个月内）
- **日志管理**：自动清理机制确保磁盘占用 < 1GB（默认 7 天保留）
- **管理面板**：PWA 安装率 > 30%（活跃用户）

## Product Principles

### 产品原则

1. **透明至上**
   - 完全兼容标准 HTTP 协议，不改变请求和响应的语义
   - 仅在必要时修改请求体（System Prompt 处理），其他情况完全透明
   - 错误信息清晰明确，便于快速定位问题

2. **性能优先**
   - 基于异步架构，最大化并发能力和资源利用率
   - 零拷贝流式转发，最小化延迟和内存占用
   - 连接池复用，减少 TCP 握手开销

3. **安全可靠**
   - 严格遵循 HTTP 规范，防止重定向攻击和请求走私
   - 自动超时机制，防止资源耗尽
   - 优雅的错误处理，上游错误正确透传
   - 生产环境日志脱敏，避免泄露敏感信息

4. **易用性**
   - 零配置透明代理，开箱即用
   - Docker 一键部署，简化运维流程
   - Web 管理面板提供直观的可视化界面
   - 详细的文档和示例，降低学习成本

5. **可扩展性**
   - 模块化设计，职责清晰，易于扩展
   - 配置驱动，支持多种部署场景
   - 为未来的插件系统和多租户功能预留接口

## Monitoring & Visibility

### 可观测性

#### Dashboard 类型
- **Web 管理面板**：基于 Vue 3 + TypeScript 的现代化单页应用
- **PWA 支持**：支持离线访问、桌面安装和自动更新
- **移动端友好**：响应式设计，支持手机和平板访问

#### 实时更新机制
- **WebSocket**：未来支持双向通信和推送通知
- **Server-Sent Events (SSE)**：实时日志流，无需轮询
- **定时轮询**：统计数据每 5 秒自动刷新

#### 关键指标展示
- **请求总览**：总请求数、成功率、失败率、平均延迟
- **时间趋势**：按小时/天统计的请求量和成功率趋势（Chart.js 可视化）
- **实时监控**：最近 50 条请求的详细信息（方法、路径、状态、延迟）
- **日志查询**：支持日期范围、关键字搜索和实时流

#### 共享能力
- **只读链接**：未来支持生成只读分享链接（带有效期）
- **数据导出**：支持导出 CSV/JSON 格式的统计数据和日志
- **报告生成**：未来支持自动生成日报/周报

## Future Vision

### 产品演进愿景

**AnyRouter Transparent Proxy** 不仅是一个解决当前问题的工具，更是一个面向未来的 AI API 管理平台。我们希望逐步将其打造成：

- **企业级 AI API 网关**：支持多租户、API Key 管理、配额控制和计费
- **智能路由和负载均衡**：支持多上游负载均衡、故障转移和灰度发布
- **可观测性平台**：集成 Prometheus、Grafana，提供企业级监控和告警
- **插件生态系统**：支持 Python 和 JavaScript 插件，允许社区贡献扩展功能

### Potential Enhancements

#### 短期改进（3-6 个月）

- **远程访问（Remote Access）**
  - Tunnel 功能：通过公网访问本地部署的管理面板
  - 只读分享链接：生成带有效期的分享链接，便于演示和汇报
  - WebSocket 支持：实时推送通知和双向通信

- **分析能力（Analytics）**
  - 历史趋势分析：长期数据存储和趋势分析
  - 性能指标：P50/P95/P99 延迟分析，慢请求识别
  - 成本分析：按用户/项目/时间段统计 API 调用成本

- **协作功能（Collaboration）**
  - 多用户支持：用户认证和权限管理
  - 评论和标注：在日志和请求上添加评论和标签
  - 团队协作：共享配置和统计数据

#### 中期规划（6-12 个月）

- **企业级功能**
  - API Key 管理：支持 API Key 验证和配额管理
  - 多租户支持：隔离不同用户/团队的数据和配置
  - 请求限流：基于 IP、API Key 或用户的请求限流

- **高级代理功能**
  - WebSocket 代理：支持 WebSocket 协议的透明代理
  - 请求缓存：基于 Redis 的请求缓存机制，减少上游调用
  - 智能重试：自动重试失败的请求，提高成功率

- **可观测性增强**
  - Prometheus metrics 端点：集成 Prometheus 监控
  - 分布式追踪：集成 OpenTelemetry，支持请求追踪
  - 告警系统：支持邮件、Slack、钉钉等告警渠道

#### 长期愿景（12+ 个月）

- **插件生态系统**
  - Python 插件：支持自定义请求处理逻辑
  - JavaScript 插件：前端扩展和自定义仪表板
  - 插件市场：社区贡献的插件共享平台

- **AI 能力增强**
  - 智能路由：基于请求内容和上游状态的智能路由
  - 异常检测：基于 AI 的异常请求检测和告警
  - 成本优化：自动推荐成本优化策略

- **开放平台**
  - RESTful API：完整的管理 API，支持外部集成
  - Webhook 支持：支持事件驱动的自动化
  - CLI 工具：命令行管理工具，支持自动化脚本

---

**产品愿景总结**：AnyRouter Transparent Proxy 致力于成为开发者和企业团队首选的 AI API 管理平台，通过提供稳定、高性能、易用的代理服务，让每个团队都能轻松集成和管理 AI 服务。
